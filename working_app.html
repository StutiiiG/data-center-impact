<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Air Quality Map - Heatmap with Hover</title>

<!-- Tailwind CSS + DaisyUI -->
<script src="https://cdn.tailwindcss.com"></script>
<script>
  tailwind.config = { theme: { extend: { colors: { "primary": "#6EC1E4", "secondary": "#1a3c54" } } } }
</script>
<link href="https://cdn.jsdelivr.net/npm/daisyui@3.3.1/dist/full.css" rel="stylesheet">

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

<style>
  html, body { height:100%; margin:0; font-family:'Inter',sans-serif; overflow:hidden; background:#111827; }
  #map { position:absolute; top:85px; bottom:0; right:0; left:15px; }

  #control-panel {
    position:absolute; top:95px; left:15px;
    width:290px; background:rgba(30,41,59,0.9);
    padding:12px; border-radius:12px;
    box-shadow:0 8px 20px rgba(0,0,0,0.5);
    z-index:500; max-height:calc(100vh - 110px); overflow-y:auto;
    color:#fff;
  }

  #footer-timestamp {
    position:absolute; bottom:10px; right:15px;
    background:rgba(30,41,59,0.85); padding:6px 12px;
    border-radius:10px; color:#f0f0f0; font-size:0.8rem;
    box-shadow:0 4px 10px rgba(0,0,0,0.3); z-index:500;
  }

  #header-wrapper { position: fixed; top:0; width:100%; z-index:1000; }
  #title-ribbon { height:40px; background: linear-gradient(to right,#0f2b42,#1a3c54); text-align:center; line-height:40px; font-weight:600; color:#e0e0e0; box-shadow:0 2px 6px rgba(0,0,0,0.5);}
  #nav-ribbon { height:50px; background:#1a3c54; display:flex; justify-content:space-between; align-items:center; padding:0 15px; }
  .nav-item { cursor:pointer; padding:0 15px; line-height:50px; font-weight:500; transition: all 0.2s; color:#e0e0e0; }
  .nav-item:hover { background:rgba(255,255,255,0.1); border-radius:6px; }
  .nav-item.active { border-bottom:3px solid #6EC1E4; }

  /* Legend */
  .legend {
    position:absolute;
    bottom:10px; left:15px;
    background:rgba(30,41,59,0.9); color:#fff;
    padding:10px; border-radius:8px;
    font-size:0.8rem; box-shadow:0 4px 10px rgba(0,0,0,0.3);
    z-index:500;
  }
  .legend div { display:flex; align-items:center; margin-bottom:4px; }
  .legend span { display:inline-block; width:16px; height:16px; margin-right:6px; border-radius:4px; }

  /* Hover AQI tooltip */
  #hover-aqi {
    position:absolute;
    pointer-events:none;
    padding:6px 10px;
    background:rgba(30,41,59,0.9);
    color:#fff;
    border-radius:8px;
    font-size:0.85rem;
    z-index:600;
    display:none;
  }
</style>
</head>
<body>

<!-- Header -->
<div id="header-wrapper">
  <div id="title-ribbon">Environmental Impact of Data Centers</div>
  <div id="nav-ribbon">
    <div class="flex gap-3">
      <div class="nav-item active">Air Quality</div>
      <div class="nav-item">Power</div>
      <div class="nav-item">Water</div>
      <div class="nav-item">CO2</div>
    </div>
    <div class="flex gap-2">
      <button class="btn btn-sm btn-primary">Info</button>
      <input type="text" placeholder="Find address" class="input input-sm input-bordered">
    </div>
  </div>
</div>

<!-- Control Panel -->
<div id="control-panel">
  <h3 class="font-semibold text-primary mb-2">Monitors - NowCast AQI</h3>
  <div class="form-control mt-2">
    <label class="cursor-pointer label">
      <input type="radio" name="monitor-layer" checked class="radio radio-sm mr-2"> Ozone and PM
    </label>
    <label class="cursor-pointer label">
      <input type="radio" name="monitor-layer" class="radio radio-sm mr-2"> Ozone only
    </label>
    <label class="cursor-pointer label">
      <input type="radio" name="monitor-layer" class="radio radio-sm mr-2"> PM2.5 only
    </label>
  </div>
</div>

<!-- Map -->
<div id="map"></div>
<div id="footer-timestamp">Loading data...</div>
<div id="hover-aqi"></div>

<!-- Legend -->
<div class="legend">
  <div><span style="background:green"></span>Good</div>
  <div><span style="background:yellow"></span>Moderate</div>
  <div><span style="background:orange"></span>Unhealthy for Sensitive</div>
  <div><span style="background:red"></span>Unhealthy</div>
  <div><span style="background:purple"></span>Very Unhealthy</div>
</div>

<!-- Leaflet + Heatmap -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

<script>
let currentPollutant = "all";
let monitorData = [];
const map = L.map('map').setView([45, -100], 4);

L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{
  attribution:'&copy; OpenStreetMap contributors &copy; CARTO', subdomains:'abcd', maxZoom:19
}).addTo(map);

function aqiToIntensity(aqi){ return Math.min(aqi/500, 0.6); }
function getColor(color){
  const colors = {green:'green', yellow:'yellow', orange:'orange', red:'red', purple:'purple'};
  return colors[color]||'gray';
}

// Load monitor data
async function loadMonitorData(retries=3){
  const apiUrl = `http://127.0.0.1:3000/api/monitors?pollutant=${currentPollutant}`;
  for(let attempt=1; attempt<=retries; attempt++){
    try{
      const res = await fetch(apiUrl);
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      monitorData = data.monitors;

      // Heatmap
      const heatPoints = monitorData
        .filter(m=>typeof m.lat==='number' && typeof m.lon==='number')
        .map(m=>[m.lat, m.lon, aqiToIntensity(m.aqi)]);
      if(window.heatLayer) map.removeLayer(window.heatLayer);
      window.heatLayer = L.heatLayer(heatPoints,{
        radius: 15, blur: 8, maxZoom: 10,
        gradient:{0:'green',0.3:'yellow',0.6:'orange',0.8:'red',1:'purple'}
      }).addTo(map);

      // Footer timestamp
      const ts = new Date(data.timestamp);
      document.getElementById('footer-timestamp').innerText = `Updated: ${ts.toLocaleString()}`;
      return;
    }catch(err){
      if(attempt===retries) alert('Failed to load monitor data!');
      await new Promise(r=>setTimeout(r, Math.pow(2,attempt)*500));
    }
  }
}

loadMonitorData();

// Radio buttons
document.getElementsByName("monitor-layer").forEach(radio=>{
  radio.addEventListener("change", ()=>{
    const label = radio.parentElement.textContent.trim();
    if(label.includes("Ozone only")) currentPollutant="ozone";
    else if(label.includes("PM2.5")) currentPollutant="pm";
    else currentPollutant="all";
    loadMonitorData();
  });
});

// Hover AQI tooltip
const hoverDiv = document.getElementById('hover-aqi');
map.on('mousemove', e=>{
  if(!monitorData || monitorData.length===0) { hoverDiv.style.display='none'; return; }
  let nearest=null, minDist=Infinity;
  monitorData.forEach(m=>{
    if(typeof m.lat==='number' && typeof m.lon==='number'){
      const dLat = e.latlng.lat - m.lat;
      const dLon = e.latlng.lng - m.lon;
      const dist = Math.sqrt(dLat*dLat + dLon*dLon);
      if(dist<minDist){ minDist=dist; nearest=m; }
    }
  });
  if(nearest && minDist<0.5){
    hoverDiv.style.display='block';
    hoverDiv.style.left = e.containerPoint.x+15+'px';
    hoverDiv.style.top = e.containerPoint.y+15+'px';
    hoverDiv.innerText = `AQI: ${nearest.aqi} (${nearest.color.toUpperCase()}) at ${nearest.city}`;
  } else { hoverDiv.style.display='none'; }
});
</script>
</body>
</html>